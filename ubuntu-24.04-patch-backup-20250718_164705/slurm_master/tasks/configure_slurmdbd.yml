---
# =============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê SLURM DATABASE DAEMON (SLURMDBD)
# =============================================================================

- name: "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ slurmdbd.conf"
  template:
    src: slurmdbd.conf.j2
    dest: /etc/slurm/slurmdbd.conf
    owner: "{{ slurm_user }}"
    group: "{{ slurm_group }}"
    mode: '0600'
    backup: yes
  notify: restart slurmdbd
  tags:
  - slurmdbd
  - config

- name: "–°–æ–∑–¥–∞–Ω–∏–µ systemd unit —Ñ–∞–π–ª–∞ –¥–ª—è slurmdbd"
  template:
    src: slurmdbd.service.j2
    dest: /etc/systemd/system/slurmdbd.service
    owner: root
    group: root
    mode: '0644'
    backup: yes
  notify:
  - reload systemd
  - restart slurmdbd
  tags:
  - slurmdbd
  - systemd

- name: "–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è environment —Ñ–∞–π–ª–æ–≤"
  file:
    path: /etc/systemd/system/slurmdbd.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
  - slurmdbd
  - systemd

- name: "–°–æ–∑–¥–∞–Ω–∏–µ environment —Ñ–∞–π–ª–∞ –¥–ª—è slurmdbd"
  copy:
    dest: /etc/systemd/system/slurmdbd.service.d/environment.conf
    content: |
      [Service]
      Environment="SLURM_CONF=/etc/slurm/slurm.conf"
      Environment="SLURMDBD_CONF=/etc/slurm/slurmdbd.conf"
      Environment="MUNGE_SOCKET=/var/run/munge/munge.socket.2"
    owner: root
    group: root
    mode: '0644'
  notify:
  - reload systemd
  - restart slurmdbd
  tags:
  - slurmdbd
  - systemd

- name: "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ systemd daemon"
  systemd:
    daemon_reload: yes
  tags:
  - slurmdbd
  - systemd

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ slurmdbd"
  command: "{{ slurm_prefix }}/sbin/slurmdbd -D -v"
  register: slurmdbd_syntax_check
  failed_when:
  - slurmdbd_syntax_check.rc != 0
  - "'usage:' not in slurmdbd_syntax_check.stderr"
  changed_when: false
  tags:
  - slurmdbd
  - validation

- name: "–°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–≥—Ä–æ—Ç–µ–π—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è slurmdbd"
  copy:
    dest: /etc/logrotate.d/slurmdbd
    content: |
      {{ slurm_log_dir }}/slurmdbd.log {
          daily
          missingok
          rotate 14
          compress
          delaycompress
          notifempty
          create 0640 {{ slurm_user }} {{ slurm_group }}
          postrotate
              /bin/systemctl reload slurmdbd 2>/dev/null || true
          endscript
      }
    owner: root
    group: root
    mode: '0644'
  tags:
  - slurmdbd
  - logging

- name: "–ó–∞–ø—É—Å–∫ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ slurmdbd —Å–µ—Ä–≤–∏—Å–∞"
  systemd:
    name: slurmdbd
    state: started
    enabled: yes
    daemon_reload: yes
  tags:
  - slurmdbd
  - services

- name: "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ slurmdbd"
  wait_for:
    path: "{{ slurm_run_dir }}/slurmdbd.pid"
    timeout: 60
    delay: 5
  tags:
  - slurmdbd
  - services

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ slurmdbd"
  systemd:
    name: slurmdbd
  register: slurmdbd_status
  tags:
  - slurmdbd
  - validation

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è slurmdbd –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
  shell: |
    {{ slurm_prefix }}/bin/sacctmgr -i list cluster
  register: slurmdbd_db_check
  failed_when: false
  changed_when: false
  tags:
  - slurmdbd
  - validation

- name: "–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)"
  shell: |
    {{ slurm_prefix }}/bin/sacctmgr -i add cluster {{ slurmctld_options.cluster_name }}
  register: cluster_creation
  failed_when:
  - cluster_creation.rc != 0
  - "'already exists' not in cluster_creation.stdout"
  changed_when: "'already exists' not in cluster_creation.stdout"
  tags:
  - slurmdbd
  - cluster
  - init

- name: "–°–æ–∑–¥–∞–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞"
  shell: |
    {{ slurm_prefix }}/bin/sacctmgr -i add account name=default Description="Default Account" Organization=HPC
  register: account_creation
  failed_when:
  - account_creation.rc != 0
  - "'already exists' not in account_creation.stdout"
  changed_when: "'already exists' not in account_creation.stdout"
  tags:
  - slurmdbd
  - accounts
  - init

- name: "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É"
  shell: |
    {{ slurm_prefix }}/bin/sacctmgr -i add account default Cluster={{ slurmctld_options.cluster_name }}
  register: account_cluster_assoc
  failed_when:
  - account_cluster_assoc.rc != 0
  - "'already exists' not in account_cluster_assoc.stdout"
  changed_when: "'already exists' not in account_cluster_assoc.stdout"
  tags:
  - slurmdbd
  - accounts
  - init

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ slurmdbd –Ω–∞ –æ—à–∏–±–∫–∏"
  shell: |
    if [ -f {{ slurm_log_dir }}/slurmdbd.log ]; then
        tail -50 {{ slurm_log_dir }}/slurmdbd.log | grep -i "error\|fatal\|fail" | head -10 || echo "No errors found"
    else
        echo "Log file not found"
    fi
  register: slurmdbd_log_check
  changed_when: false
  tags:
  - slurmdbd
  - validation

- name: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ slurmdbd"
  debug:
    msg:
    - "‚úÖ slurmdbd –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω"
    - "üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {{ database_name }} –Ω–∞ {{ database_host }}"
    - "üìÅ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: /etc/slurm/slurmdbd.conf"
    - "üìù –õ–æ–≥–∏: {{ slurm_log_dir }}/slurmdbd.log"
    - "üîÑ –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞: {{ slurmdbd_status.status.ActiveState }}"
    - "üèóÔ∏è –ö–ª–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–Ω: {{ slurmctld_options.cluster_name }}"
  tags:
  - slurmdbd
  - info

- name: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö"
  debug:
    msg:
    - "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: {{ 'OK' if slurmdbd_db_check.rc == 0 else 'FAILED' }}"
    - "üìã –õ–æ–≥–∏: {{ slurmdbd_log_check.stdout_lines | default(['–ù–µ—Ç –æ—à–∏–±–æ–∫']) }}"
  tags:
  - slurmdbd
  - info
