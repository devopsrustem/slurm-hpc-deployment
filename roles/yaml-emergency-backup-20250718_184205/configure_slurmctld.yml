---
# =============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê SLURM CONTROLLER (SLURMCTLD)
# =============================================================================

- name: "–°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ slurm.conf"
  template:
    src: slurm.conf.j2
    dest: /etc/slurm/slurm.conf
    owner: "{{slurm_user}}"
    group: "{{slurm_group}}"
    mode: '0644'
    backup: true
  notify: restart slurmctld
  tags:
    - slurmctld
    - config

- name: "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ cgroups"
  template:
    src: cgroup.conf.j2
    dest: /etc/slurm/cgroup.conf
    owner: "{{slurm_user}}"
    group: "{{slurm_group}}"
    mode: '0644'
    backup: true
  notify: restart slurmctld
  tags:
    - slurmctld
    - cgroups
    - config

- name: "–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ allowed devices –¥–ª—è cgroups"
  copy:
    dest: /etc/slurm/cgroup_allowed_devices_file.conf
    content: |
      # Allowed devices for Slurm cgroups
      # Device access control for jobs

      # Basic devices
      /dev/null rwm
      /dev/zero rwm
      /dev/full rwm
      /dev/random rwm
      /dev/urandom rwm
      /dev/pts/* rwm
      /dev/ptmx rwm
      /dev/tty rwm
      /dev/console rwm

      # GPU devices (NVIDIA)
      /dev/nvidia* rwm
      /dev/nvidiactl rwm
      /dev/nvidia-uvm rwm
      /dev/nvidia-uvm-tools rwm
      /dev/nvidia-modeset rwm

      # InfiniBand devices
      /dev/infiniband/* rwm
      /dev/rdma_cm rwm

      # Additional devices as needed
      # Add custom device access rules here
    owner: "{{slurm_user}}"
    group: "{{slurm_group}}"
    mode: '0644'
  tags:
    - slurmctld
    - cgroups
    - config

- name: "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ GRES (GPU Resources)"
  template:
    src: gres.conf.j2
    dest: /etc/slurm/gres.conf
    owner: "{{slurm_user}}"
    group: "{{slurm_group}}"
    mode: '0644'
    backup: true
  notify: restart slurmctld
  tags:
    - slurmctld
    - gres
    - config

- name: "–°–æ–∑–¥–∞–Ω–∏–µ systemd unit —Ñ–∞–π–ª–∞ –¥–ª—è slurmctld"
  template:
    src: slurmctld.service.j2
    dest: /etc/systemd/system/slurmctld.service
    owner: root
    group: root
    mode: '0644'
    backup: true
  notify:
    - reload systemd
    - restart slurmctld
  tags:
    - slurmctld
    - systemd

- name: "–°–æ–∑–¥–∞–Ω–∏–µ environment —Ñ–∞–π–ª–∞ –¥–ª—è slurmctld"
  copy:
    dest: /etc/systemd/system/slurmctld.service.d/environment.conf
    content: |
      [Service]
      Environment="SLURM_CONF=/etc/slurm/slurm.conf"
      Environment="MUNGE_SOCKET=/var/run/munge/munge.socket.2"
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd
    - restart slurmctld
  tags:
    - slurmctld
    - systemd

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ slurm.conf"
  command: "{{slurm_prefix}}/sbin/slurmctld -D -v"
  register: slurmctld_syntax_check
  failed_when:
    - slurmctld_syntax_check.rc != 0
    - "'usage:' not in slurmctld_syntax_check.stderr"
  changed_when: false
  tags:
    - slurmctld
    - validation

- name: "–°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ prolog"
  template:
    src: prolog.sh.j2
    dest: /etc/slurm/prolog.sh
    owner: root
    group: root
    mode: '0755'
    backup: true
  tags:
    - slurmctld
    - prolog
    - config

- name: "–°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ epilog"
  template:
    src: epilog.sh.j2
    dest: /etc/slurm/epilog.sh
    owner: root
    group: root
    mode: '0755'
    backup: true
  tags:
    - slurmctld
    - epilog
    - config

- name: "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è slurmctld"
  copy:
    dest: /etc/logrotate.d/slurmctld
    content: |
      {{slurm_log_dir}}/slurmctld.log {
          daily
          missingok
          rotate 14
          compress
          delaycompress
          notifempty
          create 0640 {{slurm_user}} {{slurm_group}}
          postrotate
              /bin/systemctl reload slurmctld 2>/dev/null || true
          endscript
    }

      {{slurm_log_dir}}/sched.log {
          daily
          missingok
          rotate 7
          compress
          delaycompress
          notifempty
          create 0640 {{slurm_user}} {{slurm_group}}
          postrotate
              /bin/systemctl reload slurmctld 2>/dev/null || true
          endscript
    }
    owner: root
    group: root
    mode: '0644'
  tags:
    - slurmctld
    - logging

- name: "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ systemd daemon"
  systemd:
    daemon_reload: true
  tags:
    - slurmctld
    - systemd

- name: "–ó–∞–ø—É—Å–∫ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ slurmctld —Å–µ—Ä–≤–∏—Å–∞"
  systemd:
    name: slurmctld
    state: started
    enabled: true
    daemon_reload: true
  tags:
    - slurmctld
    - services

- name: "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ slurmctld"
  wait_for:
    path: "{{slurm_run_dir}}/slurmctld.pid"
    timeout: 120
    delay: 5
  tags:
    - slurmctld
    - services

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ slurmctld"
  systemd:
    name: slurmctld
  register: slurmctld_status
  tags:
    - slurmctld
    - validation

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–æ–º–∞–Ω–¥ Slurm"
  command: "{{item}}"
  register: slurm_commands_check
  failed_when: false
  changed_when: false
  loop:
    - "{{slurm_prefix}}/bin/scontrol ping"
    - "{{slurm_prefix}}/bin/sinfo"
    - "{{slurm_prefix}}/bin/squeue"
  tags:
    - slurmctld
    - validation

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ slurmctld –Ω–∞ –æ—à–∏–±–∫–∏"
  shell: |
    if [-f {{slurm_log_dir}}/slurmctld.log]; then
        tail -50 {{slurm_log_dir}}/slurmctld.log | grep -i "error\|fatal\|fail" | head -10 || echo "No errors found"
    else
        echo "Log file not found"
    fi
  register: slurmctld_log_check
  changed_when: false
  tags:
    - slurmctld
    - validation

- name: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ slurmctld"
  debug:
    msg:
      - "‚úÖ slurmctld –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω"
      - "üìÅ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: /etc/slurm/slurm.conf"
      - "üìù –õ–æ–≥–∏: {{slurm_log_dir}}/slurmctld.log"
      - "üîÑ –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞: {{slurmctld_status.status.ActiveState}}"
      - "üèóÔ∏è –ö–ª–∞—Å—Ç–µ—Ä: {{slurmctld_options.cluster_name}}"
      - "üîç –ö–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç: {{slurm_commands_check.results | selectattr('rc', 'equalto', 0) | list | length}}/{{slurm_commands_check.results | length}}"
  tags:
    - slurmctld
    - info

- name: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–æ–∫"
  debug:
    msg:
      - "üìã –ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–º–∞–Ω–¥:"
{% for result in slurm_commands_check.results %}
      - "  {{result.cmd[0] | basename}}: {{'OK' if result.rc == 0 else 'FAILED'}}"
{% endfor %}
      - "üìã –õ–æ–≥–∏: {{slurmctld_log_check.stdout_lines | default(['–ù–µ—Ç –æ—à–∏–±–æ–∫'])}}"
  tags:
    - slurmctld
    - info