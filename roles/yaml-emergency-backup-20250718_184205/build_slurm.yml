---
# =============================================================================
# –ö–û–ú–ü–ò–õ–Ø–¶–ò–Ø –ò –£–°–¢–ê–ù–û–í–ö–ê SLURM 25.05.1
# =============================================================================

- name: "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏"
  file:
    path: "/tmp/slurm-build"
    state: directory
    owner: "{{slurm_user}}"
    group: "{{slurm_group}}"
    mode: '0755'
  tags:
  - build
  - prepare

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ Slurm"
  stat:
    path: "/tmp/slurm-build/slurm-{{slurm_version}}.tar.bz2"
  register: slurm_archive
  tags:
  - build
  - download

- name: "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ Slurm {{slurm_version}}"
  get_url:
    url: "{{slurm_download_url}}"
    dest: "/tmp/slurm-build/slurm-{{slurm_version}}.tar.bz2"
    owner: "{{slurm_user}}"
    group: "{{slurm_group}}"
    mode: '0644'
    timeout: 300
  when: not slurm_archive.stat.exists
  tags:
  - build
  - download

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã –∞—Ä—Ö–∏–≤–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)"
  shell: |
    cd /tmp/slurm-build
    echo "Verifying Slurm archive integrity..."
    file slurm-{{slurm_version}}.tar.bz2
    ls -la slurm-{{slurm_version}}.tar.bz2
  register: archive_check
  changed_when: false
  tags:
  - build
  - validation

- name: "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ Slurm"
  unarchive:
    src: "/tmp/slurm-build/slurm-{{slurm_version}}.tar.bz2"
    dest: "/tmp/slurm-build"
    remote_src: true
    owner: "{{slurm_user}}"
    group: "{{slurm_group}}"
    creates: "/tmp/slurm-build/slurm-{{slurm_version}}"
  tags:
  - build
  - extract

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è configure —Å–∫—Ä–∏–ø—Ç–∞"
  stat:
    path: "/tmp/slurm-build/slurm-{{slurm_version}}/configure"
  register: configure_script
  failed_when: not configure_script.stat.exists
  tags:
  - build
  - validation

- name: "–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è ./configure"
  set_fact:
    configure_options: >-
      --prefix={{slurm_build_options.prefix}} --sysconfdir={{slurm_build_options.sysconfdir}} --enable-pam={{slurm_build_options.enable_pam | ternary('yes', 'no')}} --enable-x11={{slurm_build_options.enable_x11 | ternary('yes', 'no')}} --with-munge={{slurm_build_options.with_munge}} --with-ssl={{slurm_build_options.with_ssl}} --with-hwloc={{slurm_build_options.with_hwloc}} --with-json={{slurm_build_options.with_json}} --with-jwt={{slurm_build_options.with_jwt}} --with-mysql_config={{slurm_build_options.with_mysql_config}} --with-hdf5={{slurm_build_options.with_hdf5}} --enable-slurmrestd={{slurm_build_options.enable_slurmrestd | ternary('yes', 'no')}} --enable-shared={{slurm_build_options.enable_shared | ternary('yes', 'no')}}
  tags:
  - build
  - config

- name: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–ø—Ü–∏–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
  debug:
    msg:
    - "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Slurm:"
    - "{{configure_options}}"
  tags:
  - build
  - info

- name: "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏ Slurm"
  command: >
    ./configure {{configure_options}}
  args:
    chdir: "/tmp/slurm-build/slurm-{{slurm_version}}"
    creates: "/tmp/slurm-build/slurm-{{slurm_version}}/config.log"
  become_user: "{{slurm_user}}"
  register: configure_result
  tags:
  - build
  - configure

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
  debug:
    var: configure_result.stdout_lines
  when: configure_result.stdout_lines is defined
  tags:
  - build
  - info

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ config.log –Ω–∞ –æ—à–∏–±–∫–∏"
  shell: |
    cd /tmp/slurm-build/slurm-{{slurm_version}}
    if [-f config.log]; then
        echo "=== Checking for configuration errors ==="
        grep -i "error\|failed\|not found" config.log | head -10 || echo "No major errors found"
        echo
        echo "=== Configuration summary ==="
        grep -A 20 "Slurm configuration summary:" config.log || echo "Summary not found"
    fi
  register: config_check
  changed_when: false
  tags:
  - build
  - validation

- name: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
  debug:
    var: config_check.stdout_lines
  tags:
  - build
  - info

- name: "–ö–æ–º–ø–∏–ª—è—Ü–∏—è Slurm (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-15 –º–∏–Ω—É—Ç)"
  command: make -j{{ansible_processor_vcpus | default(4)}}
  args:
    chdir: "/tmp/slurm-build/slurm-{{slurm_version}}"
    creates: "/tmp/slurm-build/slurm-{{slurm_version}}/src/slurmctld/slurmctld"
  become_user: "{{slurm_user}}"
  register: make_result
  tags:
  - build
  - compile

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏"
  stat:
    path: "{{item}}"
  register: compiled_binaries
  loop:
  - "/tmp/slurm-build/slurm-{{slurm_version}}/src/slurmctld/slurmctld"
  - "/tmp/slurm-build/slurm-{{slurm_version}}/src/slurmd/slurmd"
  - "/tmp/slurm-build/slurm-{{slurm_version}}/src/slurmdbd/slurmdbd"
  - "/tmp/slurm-build/slurm-{{slurm_version}}/src/slurmrestd/slurmrestd"
  failed_when: not item.stat.exists
  tags:
  - build
  - validation

- name: "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Slurm"
  command: make install
  args:
    chdir: "/tmp/slurm-build/slurm-{{slurm_version}}"
    creates: "{{slurm_prefix}}/sbin/slurmctld"
  tags:
  - build
  - install

- name: "–°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –±–∏–Ω–∞—Ä–µ–π"
  file:
    src: "{{slurm_prefix}}/{{item.src}}"
    dest: "{{item.dest}}"
    state: link
    force: true
  loop:
  - {src: "bin/sinfo", dest: "/usr/local/bin/sinfo"}
  - {src: "bin/squeue", dest: "/usr/local/bin/squeue"}
  - {src: "bin/scancel", dest: "/usr/local/bin/scancel"}
  - {src: "bin/sbatch", dest: "/usr/local/bin/sbatch"}
  - {src: "bin/srun", dest: "/usr/local/bin/srun"}
  - {src: "bin/scontrol", dest: "/usr/local/bin/scontrol"}
  - {src: "bin/sacct", dest: "/usr/local/bin/sacct"}
  - {src: "bin/sacctmgr", dest: "/usr/local/bin/sacctmgr"}
  - {src: "sbin/slurmctld", dest: "/usr/local/sbin/slurmctld"}
  - {src: "sbin/slurmd", dest: "/usr/local/sbin/slurmd"}
  - {src: "sbin/slurmdbd", dest: "/usr/local/sbin/slurmdbd"}
  - {src: "sbin/slurmrestd", dest: "/usr/local/sbin/slurmrestd"}
  tags:
  - build
  - install
  - links

- name: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã—Ö –ø—É—Ç–µ–π"
  blockinfile:
    path: /etc/ld.so.conf.d/slurm.conf
    create: true
    block: |
      # Slurm library paths
      {{slurm_prefix}}/lib
      {{slurm_prefix}}/lib64
    marker: "# {mark} ANSIBLE MANAGED BLOCK"
  notify: ldconfig
  tags:
  - build
  - install
  - libraries

- name: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫"
  command: ldconfig
  tags:
  - build
  - install
  - libraries

- name: "–°–æ–∑–¥–∞–Ω–∏–µ man pages –ø—É—Ç–µ–π"
  blockinfile:
    path: /etc/manpath.config
    block: |
      # Slurm man pages
      MANPATH_MAP {{slurm_prefix}}/bin {{slurm_prefix}}/share/man
      MANPATH_MAP {{slurm_prefix}}/sbin {{slurm_prefix}}/share/man
    marker: "# {mark} ANSIBLE MANAGED BLOCK - SLURM"
    backup: true
  ignore_errors: yes # –§–∞–π–ª –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö
  tags:
  - build
  - install
  - documentation

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ Slurm"
  command: "{{slurm_prefix}}/bin/scontrol --version"
  register: slurm_version_check
  changed_when: false
  tags:
  - build
  - validation

- name: "–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –æ —Å–±–æ—Ä–∫–µ"
  copy:
    dest: "{{slurm_prefix}}/BUILD_INFO"
    content: |
      Slurm Build Information
      ======================

      Version: {{slurm_version}}
      Built on: {{ansible_date_time.iso8601}}
      Built by: Ansible (slurm-hpc-deployment)
      Hostname: {{inventory_hostname}}

      Configure options:
      {{configure_options}}

      Build environment:
      - OS: {{ansible_distribution}} {{ansible_distribution_version}}
      - Kernel: {{ansible_kernel}}
      - CPU: {{ansible_processor_vcpus}} cores
      - Memory: {{ansible_memtotal_mb}}MB

      Installed components:
      {% for binary in compiled_binaries.results %}
      - {{binary.item | basename}}: {{'OK' if binary.stat.exists else 'MISSING'}}
      {% endfor %}
    owner: root
    group: root
    mode: '0644'
  tags:
  - build
  - install
  - documentation

- name: "–û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–±–æ—Ä–∫–∏"
  file:
    path: "/tmp/slurm-build"
    state: absent
  when: cleanup_build_files | default(true)
  tags:
  - build
  - cleanup

- name: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–±–æ—Ä–∫–∏"
  debug:
    msg:
    - "‚úÖ Slurm {{slurm_version}} —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    - "üìÅ –ü—Ä–µ—Ñ–∏–∫—Å: {{slurm_prefix}}"
    - "üîß –í–µ—Ä—Å–∏—è: {{slurm_version_check.stdout}}"
    - "üîó –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ —Å–æ–∑–¥–∞–Ω—ã –≤ /usr/local/"
    - "üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ /etc/ld.so.conf.d/"
    - "üìñ Man pages –¥–æ—Å—Ç—É–ø–Ω—ã"
  tags:
  - build
  - info
