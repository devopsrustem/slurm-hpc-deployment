---
# =============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê MYSQL –î–õ–Ø SLURM ACCOUNTING
# =============================================================================
- name: "–ó–∞–ø—É—Å–∫ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ MySQL —Å–µ—Ä–≤–∏—Å–∞"
  systemd:
    name: mysql
    state: started
    enabled: true
    daemon_reload: true
  tags:
  - mysql
  - services
- name: "–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ MySQL"
  wait_for:
    port: 3306
    host: "{{database_host}}"
    timeout: 60
    delay: 10
  tags:
  - mysql
- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ MySQL"
  command: systemctl is-active mysql
  register: mysql_status
  changed_when: false
  failed_when: mysql_status.rc != 0
  tags:
  - mysql
  - validation
- name: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ root –ø–∞—Ä–æ–ª—è MySQL (–ø—Ä–∏ –ø–µ—Ä–≤–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ)"
  mysql_user:
    name: root
    password: "{{mysql_root_password}}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    state: present
  ignore_errors: yes # –ú–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
  tags:
  - mysql
  - security
- name: "–°–æ–∑–¥–∞–Ω–∏–µ .my.cnf –¥–ª—è root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
  template:
    src: my.cnf.j2
    dest: /root/.my.cnf
    owner: root
    group: root
    mode: '0600'
    backup: true
  tags:
  - mysql
  - config
- name: "–£–¥–∞–ª–µ–Ω–∏–µ –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π MySQL"
  mysql_user:
    name: ''
    host_all: true
    state: absent
    login_user: root
    login_password: "{{mysql_root_password}}"
  ignore_errors: true
  tags:
  - mysql
  - security
- name: "–£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
  mysql_db:
    name: test
    state: absent
    login_user: root
    login_password: "{{mysql_root_password}}"
  ignore_errors: true
  tags:
  - mysql
  - security
- name: "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ MySQL –¥–ª—è Slurm"
  blockinfile:
    path: /etc/mysql/mysql.conf.d/slurm.cnf
    create: true
    backup: true
    block: |
      # MySQL configuration for Slurm accounting
      [mysqld]
      # Performance tuning for Slurm
      innodb_buffer_pool_size = {{mysql_innodb_buffer_pool_size}}
      innodb_log_file_size = {{mysql_innodb_log_file_size}}
      innodb_flush_log_at_trx_commit = 2
      innodb_file_per_table = 1
      # Connection settings
      max_connections = 1000
      max_allowed_packet = 64M
      # Timeout settings
      wait_timeout = 28800
      interactive_timeout = 28800
      # Query cache (for older MySQL versions)
      query_cache_size = 128M
      query_cache_type = 1
      # Slow query log
      slow_query_log = 1
      slow_query_log_file = /var/log/mysql/mysql-slow.log
      long_query_time = 2
      # Binary logging
      log_bin = /var/log/mysql/mysql-bin.log
      binlog_expire_logs_seconds = 864000  # 10 days
      # Character set
      character_set_server = utf8mb4
      collation_server = utf8mb4_unicode_ci
    marker: "# {mark} ANSIBLE MANAGED BLOCK - SLURM CONFIG"
  notify: restart mysql
  tags:
  - mysql
  - config
- name: "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ MySQL —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π"
  systemd:
    name: mysql
    state: restarted
  tags:
  - mysql
  - restart
- name: "–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ MySQL –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞"
  wait_for:
    port: 3306
    host: "{{database_host}}"
    timeout: 60
    delay: 5
  tags:
  - mysql
- name: "–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Slurm accounting"
  mysql_db:
    name: "{{database_name}}"
    state: present
    encoding: utf8mb4
    collation: utf8mb4_unicode_ci
    login_user: root
    login_password: "{{mysql_root_password}}"
  tags:
  - mysql
  - database
- name: "–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Slurm"
  mysql_user:
    name: "{{database_user}}"
    password: "{{database_password}}"
    priv: "{{database_name}}.*:ALL"
    host: "{{item}}"
    state: present
    login_user: root
    login_password: "{{mysql_root_password}}"
  loop:
  - localhost
  - "{{inventory_hostname}}"
  - "{{ansible_default_ipv4.address}}"
  tags:
  - mysql
  - database
  - users
- name: "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é Slurm"
  mysql_user:
    name: "{{database_user}}"
    priv: "information_schema.*:SELECT"
    append_privs: true
    host: localhost
    login_user: root
    login_password: "{{mysql_root_password}}"
  tags:
  - mysql
  - database
  - users
- name: "–°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ë–î"
  template:
    src: mysql_backup.sh.j2
    dest: /usr/local/bin/slurm_mysql_backup.sh
    owner: root
    group: root
    mode: '0755'
  when: backup_enabled | bool
  tags:
  - mysql
  - backup
- name: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"
  cron:
    name: "Slurm MySQL backup"
    minute: "0"
    hour: "2"
    job: "/usr/local/bin/slurm_mysql_backup.sh"
    user: root
    state: present
  when: backup_enabled | bool
  tags:
  - mysql
  - backup
  - cron
- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö"
  mysql_db:
    name: "{{database_name}}"
    state: present
    login_user: "{{database_user}}"
    login_password: "{{database_password}}"
    login_host: "{{database_host}}"
  tags:
  - mysql
  - validation
- name: "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ MySQL"
  shell: |
    mysql -u{{database_user}} -p{{database_password}} -h{{database_host}} {{database_name}} -e "
    SELECT
        @@version as mysql_version,
        @@innodb_buffer_pool_size as buffer_pool_size,
        @@max_connections as max_connections,
        @@character_set_server as charset,
        @@collation_server as collation;
    "
  register: mysql_config_check
  changed_when: false
  tags:
  - mysql
  - validation
- name: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ MySQL"
  debug:
    var: mysql_config_check.stdout_lines
  tags:
  - mysql
  - info
- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ MySQL –Ω–∞ –æ—à–∏–±–∫–∏"
  shell: "tail -50 /var/log/mysql/error.log | grep -i error || echo 'No errors found'"
  register: mysql_error_check
  changed_when: false
  tags:
  - mysql
  - validation
- name: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ MySQL"
  debug:
    msg:
    - "‚úÖ MySQL —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    - "üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {{database_name}}"
    - "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{database_user}}"
    - "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è Slurm"
    - "üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ: {{'–≤–∫–ª—é—á–µ–Ω–æ' if backup_enabled else '–æ—Ç–∫–ª—é—á–µ–Ω–æ'}}"
  tags:
  - mysql
  - info
