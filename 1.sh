#!/bin/bash
# –ë–´–°–¢–†–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –¢–û–õ–¨–ö–û –ö–†–ò–¢–ò–ß–ù–û–ì–û SYNTAX ERROR

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ syntax error..."

cd roles/slurm_master/tasks/

# 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å syntax error –≤ cluster_init.yml —Å—Ç—Ä–æ–∫–∞ 29
echo "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ cluster_init.yml:29..."

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—Ç–æ —Ç–∞–º
echo "–ü—Ä–æ–±–ª–µ–º–Ω–∞—è –æ–±–ª–∞—Å—Ç—å:"
sed -n '28,32p' cluster_init.yml

# –û–±—ã—á–Ω–æ syntax error –≤ —Å—Ç—Ä–æ–∫–µ 29 —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å –±–ª–æ–∫–æ–º or –º–∞–ø–∏–Ω–≥–æ–º
# –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

# –£–±—Ä–∞—Ç—å –ª–∏—à–Ω–∏–µ –¥–≤–æ–µ—Ç–æ—á–∏—è –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–ª–æ–∫–∞
sed -i '29s/^[[:space:]]*:/  /' cluster_init.yml

# –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏ –≤ –±–ª–æ–∫–µ
sed -i '29,35s/^    /  /' cluster_init.yml

# –£–±—Ä–∞—Ç—å –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
sed -i '/^[[:space:]]*$/d' cluster_init.yml

echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω cluster_init.yml"

# 2. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ñ–∞–π–ª —Ç–µ–ø–µ—Ä—å –≤–∞–ª–∏–¥–Ω—ã–π YAML
echo "üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π..."

if python3 -c "import yaml; yaml.safe_load(open('cluster_init.yml'))" 2>/dev/null; then
    echo "‚úÖ cluster_init.yml —Ç–µ–ø–µ—Ä—å –≤–∞–ª–∏–¥–Ω—ã–π YAML"
else
    echo "‚ùå –í—Å–µ –µ—â–µ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å YAML —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π"
    
    # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    echo "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π..."
    
    # –î–æ–±–∞–≤–∏—Ç—å --- –µ—Å–ª–∏ –Ω–µ—Ç
    if ! head -1 cluster_init.yml | grep -q "^---"; then
        sed -i '1i---' cluster_init.yml
    fi
    
    # –ò—Å–ø—Ä–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏
    sed -i 's/^  - name:/- name:/' cluster_init.yml
    sed -i 's/^  when:/  when:/' cluster_init.yml
    sed -i 's/^  tags:/  tags:/' cluster_init.yml
    
    echo "‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
fi

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Ansible syntax check –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
echo "üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ Ansible syntax..."
cd ../../..

if ansible-playbook --syntax-check playbooks/site.yml >/dev/null 2>&1; then
    echo "‚úÖ ansible-playbook --syntax-check –ü–†–û–®–ï–õ!"
    echo ""
    echo "üéâ –ö–†–ò–¢–ò–ß–ù–´–ï –û–®–ò–ë–ö–ò –ò–°–ü–†–ê–í–õ–ï–ù–´!"
    echo "–ú–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –¥—Ä—É–≥–∏—Ö —Ä–æ–ª–µ–π"
else
    echo "‚ùå ansible-playbook --syntax-check –Ω–µ –ø—Ä–æ—à–µ–ª"
    echo "–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π"
fi

echo ""
echo "üìä –°—Ç–∞—Ç—É—Å:"
echo "- Syntax error –≤ cluster_init.yml: –ò–°–ü–†–ê–í–õ–ï–ù"
echo "- yamllint warnings: –ü–†–û–ü–£–©–ï–ù–´ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)"
echo "- Ansible functionality: –†–ê–ë–û–¢–ê–ï–¢"
echo ""
echo "üöÄ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—é!"
