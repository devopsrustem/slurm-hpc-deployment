---
# =============================================================================
# –û–°–ù–û–í–ù–´–ï –ó–ê–î–ê–ß–ò –†–û–õ–ò SLURM_MASTER
# =============================================================================

- name: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Slurm master"
  debug:
    msg:
    - "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Slurm Master: {{ inventory_hostname }}"
    - "–í–µ—Ä—Å–∏—è Slurm: {{ slurm_version }}"
    - "–ö–ª–∞—Å—Ç–µ—Ä: {{ slurmctld_options.cluster_name }}"
    - "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {{ database_type }} –Ω–∞ {{ database_host }}"
    - "JWT –≤–∫–ª—é—á–µ–Ω: {{ jwt_options.enabled }}"
    - "REST API –≤–∫–ª—é—á–µ–Ω: {{ slurmrestd_options.enabled }}"
  tags:
  - info
  - always

- name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ —Ö–æ—Å—Ç–∞"
  assert:
    that:
    - inventory_hostname in groups['slurm_master']
    fail_msg: "–≠—Ç–∞ —Ä–æ–ª—å –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –∫ —Ö–æ—Å—Ç–∞–º –∏–∑ –≥—Ä—É–ø–ø—ã slurm_master"
    success_msg: "–•–æ—Å—Ç {{ inventory_hostname }} –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ slurm_master"
  tags:
  - validation

- name: "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
  include_tasks: packages.yml
  tags:
  - packages
  - dependencies

- name: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö MySQL"
  include_tasks: mysql.yml
  tags:
  - mysql
  - database

- name: "–ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Slurm"
  include_tasks: build_slurm.yml
  tags:
  - build
  - compile
  - slurm

- name: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Slurm Database Daemon (slurmdbd)"
  include_tasks: configure_slurmdbd.yml
  tags:
  - slurmdbd
  - database
  - config

- name: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Slurm Controller (slurmctld)"
  include_tasks: configure_slurmctld.yml
  tags:
  - slurmctld
  - controller
  - config

- name: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"
  include_tasks: configure_jwt.yml
  when: jwt_options.enabled | bool
  tags:
  - jwt
  - auth
  - security

- name: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Slurm REST API (slurmrestd)"
  include_tasks: configure_slurmrestd.yml
  when: slurmrestd_options.enabled | bool
  tags:
  - slurmrestd
  - api
  - rest

- name: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–æ–≤"
  include_tasks: services.yml
  tags:
  - services
  - systemd

- name: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤"
  include_tasks: cluster_init.yml
  tags:
  - cluster
  - init
  - accounts

- name: "–í–∞–ª–∏–¥–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
  include_tasks: validation.yml
  tags:
  - validation
  - test

- name: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"
  include_tasks: backup.yml
  when: backup_enabled | bool
  tags:
  - backup
  - maintenance

- name: "–§–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Slurm Master"
  debug:
    msg:
    - "‚úÖ Slurm Master —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ {{ inventory_hostname }}"
    - "üîß –°–µ—Ä–≤–∏—Å—ã: {{ slurm_master_services | join(', ') }}"
    - "üåê REST API: http://{{ inventory_hostname }}:{{ slurmrestd_options.port }}"
    - "üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {{ database_name }} –Ω–∞ {{ database_host }}"
    - "üîê JWT –∫–ª—é—á–∏: {{ jwt_options.key_file }}"
    - "üìù –õ–æ–≥–∏: {{ slurm_log_dir }}"
    - "‚ö° –ì–æ—Ç–æ–≤ –∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é compute –Ω–æ–¥"
  tags:
  - info
  - always
